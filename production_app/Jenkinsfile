pipeline {
    agent {label "build-test-slave-2"}

    environment {
        TIME = sh(script: 'date "+%Y-%m-%d %H:%M:%S"', returnStdout: true).trim()
    }

    parameters {
        string(name: 'imagename', defaultValue: '', description: 'Name of the Docker image')
        string(name: 'imagetag', defaultValue: '', description: 'Image tag for Docker build')
    }

    stages {
        stage('Clone') {
            steps {
                dir('/home/ubuntu/workspace/build and test pipeline/') {
                    sh 'rm -rf *'
                    sh 'git clone https://github.com/PokiBal/MyProject_1.git'
                }
            }
        }
        stage('Build DockerImage'){
            steps{
                echo "build image"
                dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app'){
                sh "docker build -t ${params.imagename}:${params.imagetag} ."
                }
            }
        }
        stage('Run Container'){
            steps{
                sh "docker run -it --name flask-app -p 5000:5000 -d ${params.imagename}:${params.imagetag}"
                }
        }
        stage("build user") {
            steps{
                wrap([$class: 'BuildUser', useGitAuthor: true]) {
                    sh "export USERNAME=${BUILD_USER}"
                    echo 'BUILD_USER'
                }
                echo 'BUILD_USER'
            }
        }
        stage('test application') {
            steps {
                echo "test"
                dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app/'){
                sh 'pytest tests.py::Test_class::test_signup --html=test_report.html'
                }
            }
        }
        stage ('upload to s3 bucket'){
            steps {
                withAWS(credentials: 'AWScredentials') {
                    sh '/root/.local/bin/aws s3 cp "/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app/test_report.html" "s3://project1-results"'
                }
            }
        }
        stage('UploadToDynamoDB') {
            steps {
                dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app') {
                    script {
                        def log_entry = sh(script: 'python3.8 logfile.py', returnStdout: true).trim()
                        def log_parts = log_entry.split(',')
                        if (log_parts.size() >= 2) {
                            def timestamp = log_parts[0]
                            def message = log_parts[1].replaceAll('"', '\\"')
                            withAWS(credentials: 'AWScredentials', region: 'us-east-1') {
                                sh "aws dynamodb put-item --table-name project_build_report --item \"{\\\"user\\\": {\\\"S\\\": \\\"${env.BUILD_USER}\\\"}, \\\"date\\\": {\\\"S\\\": \\\"${timestamp}\\\"}, \\\"result\\\": {\\\"S\\\": \\\"${message}\\\"}}\""
                            }
                        } else {
                            error "Invalid log entry format: $log_entry"
                        }
                    }
                }
            }
        }
        stage('UploadImageToDockerHub') {
        steps {
            script {
                def dockerImageName = "${params.imagename}:${params.imagetag}"
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_HUB_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_PASSWORD"
                    echo "login"
                    sh "docker tag ${dockerImageName} puki121/project:${params.imagetag}"
                    sh "docker push puki121/project:${params.imagetag}"
                    build job: 'production_2', parameters: [
                    // string(name: 'imagename', value: params.imagename),
                    string(name: 'imagetag', value: params.imagetag)]                
                    }
            }
        }
        }
    }
}

