pipeline {
    agent {label "slave1"}
    environment {
        TIME = sh(script: 'date "+%Y-%m-%d %H:%M:%S"', returnStdout: true).trim()
    }

    parameters {
        string(name: 'imagename', defaultValue: '', description: 'Name of the Docker image')
        string(name: 'imagetag', defaultValue: '', description: 'Image tag for Docker build')
    }

    stages {
        // stage('GitSCM') {
        //     steps {
        //         checkout([
        //         $class: 'GitSCM',
        //         //branches - can add more than 1 branch
        //         branches: [[name: 'main']],
        //         //add the usrl for the branch you want to coonect to, adding the ssh url or https???
        //         userRemoteConfigs: [[
        //             url: 'https://github.com/PokiBal/MyProject_1.git',
        //             credentialsId: ''
        //         ]]
        //     ])
        //     }
        // }
        stage('Clone') {
            steps {
                dir('/home/ubuntu/workspace/build and test pipeline/') {
                    sh 'rm -rf *'
                    sh 'git clone https://github.com/PokiBal/MyProject_1.git'
                }
            }
        }
        stage('Build DockerImage'){
            steps{
                echo "build image"
                dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app'){
                sh "docker build -t ${params.imagename}:${params.imagetag} ."
                }
            }
        }
        stage('Run Container'){
            steps{
                sh "docker run -it --name my-flask -p 5000:5000 -d ${params.imagename}:${params.imagetag}"
                }
        }
        stage("build user") {
            steps{
                wrap([$class: 'BuildUser', useGitAuthor: true]) {
                    sh "export USERNAME=${BUILD_USER}"
                }
            }
        }

        stage('Test') {
            steps {
                echo "test"
                dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app'){
                sh 'pytest tests.py::Test_class --html=test_report.html'
                }
            }
        }
        stage ('upload to s3 bucket'){
            steps{
            dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app') {
                withAWS(credentials: 'aws-credentials'){
                     sh 'aws s3 cp test_report.html s3://project1-results'
                }
            }
            }
        }

        stage('UploadToDynamoDB') {
            steps {       
            dir('/home/ubuntu/workspace/build and test pipeline/MyProject_1/production_app') {
                script {
                    def log_entry = sh(script: 'python3.8 logfile.py', returnStdout: true).trim()
                    def (timestamp, message) = log_entry.split(',')
                    message = message.replaceAll('"', '\\"') // add this line to escape quotation marks
                    withAWS(credentials: 'aws-credentials', region: 'us-east-1') {
                    sh "aws dynamodb put-item --table-name project1-results --item \"{\\\"user\\\": {\\\"S\\\": \\\"${env.BUILD_USER}\\\"}, \\\"timestamp\\\": {\\\"S\\\": \\\"${timestamp}\\\"}, \\\"message\\\": {\\\"S\\\": \\\"${message}\\\"}}\""
                    }
                }
            }
            }
        }
        stage('UploadToDockerHub') {
            steps {
                script{
                    def dockerHubUsername = 'puki121'
                    def dockerImageName = "${params.imagename}:${params.imagetag}"
                    def dockerHubCredentials = 'docker-hub'

                    sh "docker login -u ${dockerHubUsername} -p ${dockerHubCredentials}"
                    sh "docker tag ${dockerImageName} ${dockerHubUsername}/${dockerImageName}"
                    sh "docker push ${dockerHubUsername}/${dockerImageName}"
                }
            }
        }
    }
}
